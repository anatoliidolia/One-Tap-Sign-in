<?php

/**
 * @var $block OneTap
 * @var $escaper Escaper
 */

use PeachCode\GoogleOneTap\Block\OneTap;
use Magento\Framework\Escaper;

var_dump(!$block->isCustomerLoggedIn());
var_dump($block->isEnable());

if (!$block->isCustomerLoggedIn() && $block->isEnable()) {
    $clientId = $escaper->escapeHtml($block->getClientId());
    $loginUri = $escaper->escapeUrl($this->getUrl('customer/account'));
    $autoSign = $block->getAutoSign() ? 'data-auto_select="true"' : '';
    $cancelOnTapOutside = (!$block->getClickDisable() && !$block->getAutoSign()) ? 'data-cancel_on_tap_outside="false"' : '';
    ?>

    <div id="g_id_onload"
         data-client_id="<?= $clientId ?>"
         data-context="signin"
         data-callback="googleLoginEndpoint"
         data-login_uri="<?= $loginUri ?>"
        <?= $autoSign ?>
        <?= $cancelOnTapOutside ?>
         data-itp_support="true">
    </div>

    <script>
        function googleLoginEndpoint(googleUser) {
            const ajax = new XMLHttpRequest();
            ajax.open("POST", window.BASE_URL + "PeachCode_GoogleOneTap/checkout/response", true);
            ajax.onreadystatechange = function() {
                if (this.readyState === 4 && this.status === 200) {
                    window.location.reload();
                }
            };
            let formData = new FormData();
            formData.append("id_token", googleUser.credential);
            ajax.send(formData);
        }
    </script>
<?php } ?>

<script>
    require(['jquery'], function($) {
        $(document).ready(function() {
            let myInterval = setInterval(function() {
                let container = $('#credential_picker_container');
                if (container.length) {
                    container.addClass("<?= $escaper->escapeHtml($block->getPosition()) ?>");
                    clearInterval(myInterval);
                }
            }, 100);
        });
    });
</script>
